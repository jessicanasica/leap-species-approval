"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[745],{152(Y,N,b){b.d(N,{B:()=>I});var C=b(8839),k=b(9974),g=b(4360);function I(_,j=C.E){return(0,k.N)((G,e)=>{let d=null,T=null,a=null;const m=()=>{if(d){d.unsubscribe(),d=null;const u=T;T=null,e.next(u)}};function c(){const u=a+_,P=j.now();if(P<u)return d=this.schedule(void 0,u-P),void e.add(d);m()}G.subscribe((0,g._)(e,u=>{T=u,a=j.now(),d||(d=j.schedule(c,_),e.add(d))},()=>{m(),e.complete()},void 0,()=>{T=d=null}))})}},745(Y,N,b){b.d(N,{PollutionPageModule:()=>he});var C=b(2200),k=b(4341),g=b(7343),I=b(8132),_=b(467),j=b(7762),G=b(152),e=b(3664),d=b(2615),T=b(5921),a=b(3205),m=b(4632),c=b(5010),u=b(918),P=b(9187),M=b(7643);function w(r,p){if(1&r&&(e.j41(0,"span"),e.EFF(1),e.k0s()),2&r){const s=e.XpG();e.R7$(),e.SpI(" (edited: ",s.getEditedDateTime(),")")}}function E(r,p){1&r&&e.nrm(0,"ion-icon",63)}function W(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",8),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(!o.viewMode&&o.editZone())}),e.nrm(1,"ion-icon",64),e.j41(2,"span",10),e.EFF(3),e.k0s()()}if(2&r){let s;const t=e.XpG();e.R7$(3),e.JRh(t.getZoneName(null==(s=t.pollutionForm.get("zoneNumber"))?null:s.value))}}function U(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",8),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(!o.viewMode&&o.editQuad())}),e.nrm(1,"ion-icon",65),e.j41(2,"span",10),e.EFF(3),e.k0s()()}if(2&r){let s;const t=e.XpG();e.R7$(3),e.SpI("Quad ",t.getQuadDisplay(null==(s=t.pollutionForm.get("quadNumber"))?null:s.value))}}function $(r,p){if(1&r){const s=e.RV6();e.j41(0,"span",66),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.editLocationAdmin())}),e.EFF(1," Edit location "),e.k0s()}}function A(r,p){1&r&&(e.j41(0,"ion-error",67),e.EFF(1," Location is required "),e.k0s())}function B(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",68)(1,"ion-button",69),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.enableEditMode())}),e.nrm(2,"ion-icon",70),e.EFF(3," Edit This Entry "),e.k0s()()}}function z(r,p){1&r&&(e.j41(0,"div",71),e.nrm(1,"ion-icon",72),e.j41(2,"span"),e.EFF(3,"Editing Entry - Changes will replace the original submission"),e.k0s()())}function V(r,p){1&r&&(e.j41(0,"p",73),e.nrm(1,"ion-icon",74),e.EFF(2," Tap to get current GPS location "),e.k0s())}function q(r,p){if(1&r&&(e.j41(0,"p",75),e.nrm(1,"ion-icon",76),e.EFF(2),e.k0s()),2&r){const s=e.XpG();e.R7$(2),e.Lme(" ",s.coordinates.latitude.toFixed(6),", ",s.coordinates.longitude.toFixed(6)," ")}}function L(r,p){1&r&&(e.j41(0,"p",77),e.nrm(1,"ion-icon",78),e.EFF(2," GPS captured when creating new site "),e.k0s())}function X(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",79),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.captureIndividualPhoto("greyWater"))}),e.nrm(1,"ion-icon",80),e.EFF(2," Take Photo "),e.k0s()}}function Q(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",86),e.bIt("click",function(){d.eBV(s);const o=e.XpG(2);return d.Njj(o.removeIndividualPhoto("greyWater"))}),e.nrm(1,"ion-icon",87),e.k0s()}}function K(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",81)(1,"div",82)(2,"img",83),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.openFullScreenPhoto(o.greyWaterPhoto,"Grey Water"))}),e.k0s(),e.j41(3,"small",84),e.EFF(4,"Tap to view full size"),e.k0s()(),e.DNE(5,Q,2,0,"ion-button",85),e.k0s()}if(2&r){const s=e.XpG();e.R7$(2),e.Y8G("src",s.greyWaterPhoto,e.B4B),e.R7$(3),e.Y8G("ngIf",!s.viewMode)}}function Z(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",79),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.captureIndividualPhoto("sewage"))}),e.nrm(1,"ion-icon",80),e.EFF(2," Take Photo "),e.k0s()}}function H(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",86),e.bIt("click",function(){d.eBV(s);const o=e.XpG(2);return d.Njj(o.removeIndividualPhoto("sewage"))}),e.nrm(1,"ion-icon",87),e.k0s()}}function J(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",81)(1,"div",82)(2,"img",88),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.openFullScreenPhoto(o.sewagePhoto,"Sewage"))}),e.k0s(),e.j41(3,"small",84),e.EFF(4,"Tap to view full size"),e.k0s()(),e.DNE(5,H,2,0,"ion-button",85),e.k0s()}if(2&r){const s=e.XpG();e.R7$(2),e.Y8G("src",s.sewagePhoto,e.B4B),e.R7$(3),e.Y8G("ngIf",!s.viewMode)}}function ee(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",79),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.captureIndividualPhoto("trash"))}),e.nrm(1,"ion-icon",80),e.EFF(2," Take Photo "),e.k0s()}}function te(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",86),e.bIt("click",function(){d.eBV(s);const o=e.XpG(2);return d.Njj(o.removeIndividualPhoto("trash"))}),e.nrm(1,"ion-icon",87),e.k0s()}}function oe(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",81)(1,"div",82)(2,"img",89),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.openFullScreenPhoto(o.trashPhoto,"Trash"))}),e.k0s(),e.j41(3,"small",84),e.EFF(4,"Tap to view full size"),e.k0s()(),e.DNE(5,te,2,0,"ion-button",85),e.k0s()}if(2&r){const s=e.XpG();e.R7$(2),e.Y8G("src",s.trashPhoto,e.B4B),e.R7$(3),e.Y8G("ngIf",!s.viewMode)}}function ne(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",86),e.bIt("click",function(){d.eBV(s);const o=e.XpG().index,n=e.XpG();return d.Njj(n.removePhoto(o))}),e.nrm(1,"ion-icon",87),e.k0s()}}function ie(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",90)(1,"div",82)(2,"img",91),e.bIt("click",function(){const o=d.eBV(s).$implicit,n=e.XpG();return d.Njj(n.openFullScreenPhoto(o,"Pollution"))}),e.k0s(),e.j41(3,"small",84),e.EFF(4,"Tap to view full size"),e.k0s()(),e.DNE(5,ne,2,0,"ion-button",85),e.k0s()}if(2&r){const s=p.$implicit,t=p.index,o=e.XpG();e.R7$(2),e.Y8G("alt",e.VkB("Pollution photo ",t+1))("src",s,e.B4B),e.R7$(3),e.Y8G("ngIf",!o.viewMode)}}function re(r,p){if(1&r){const s=e.RV6();e.j41(0,"ion-button",92),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.capturePhoto())}),e.nrm(1,"ion-icon",80),e.EFF(2),e.k0s()}if(2&r){const s=e.XpG();e.R7$(2),e.SpI(" Add Photo (",s.photos.length,"/5) ")}}function ae(r,p){1&r&&e.nrm(0,"ion-icon",93)}function le(r,p){1&r&&e.nrm(0,"ion-icon",94)}function se(r,p){1&r&&(e.j41(0,"ion-error"),e.EFF(1," Description is required "),e.k0s())}function ce(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",95)(1,"ion-button",96),e.nrm(2,"ion-icon",97),e.EFF(3," Submit Pollution Report "),e.k0s(),e.j41(4,"ion-button",98),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.saveDraft())}),e.nrm(5,"ion-icon",99),e.EFF(6," Save Draft "),e.k0s(),e.j41(7,"ion-button",100),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.discardForm())}),e.nrm(8,"ion-icon",101),e.EFF(9," Discard "),e.k0s()()}if(2&r){const s=e.XpG();e.R7$(),e.Y8G("disabled",!s.pollutionForm.valid)}}function de(r,p){if(1&r){const s=e.RV6();e.j41(0,"div",102)(1,"ion-button",103),e.bIt("click",function(){d.eBV(s);const o=e.XpG();return d.Njj(o.deleteEntry())}),e.nrm(2,"ion-icon",101),e.EFF(3," Delete Entry "),e.k0s()()}}let ue=(()=>{var r;class p{forceDeleteDraftFile(t){var o=this;return(0,_.A)(function*(){for(let n=0;n<3;n++)try{yield o.sharedDataService.deleteJsonFile(t),console.log(`Draft file force deleted successfully (attempt ${n+1})`);break}catch(i){if(console.error(`Error force deleting draft file (attempt ${n+1}):`,i),2===n)try{yield o.sharedDataService.writeJsonFile(t,null),console.log("Draft file cleared with null write")}catch(l){console.error("Failed to clear draft file with null write:",l)}yield new Promise(l=>setTimeout(l,100))}})()}constructor(t,o,n,i,l,h,v,f,x,y,F,O,S){this.formBuilder=t,this.alertController=o,this.loadingController=n,this.modalController=i,this.router=l,this.route=h,this.popoverController=v,this.auth=f,this.pollutionSyncService=x,this.photoService=y,this.sharedDataService=F,this.entryDeletionService=O,this.siteSyncService=S,this.progress=0,this.photos=[],this.coordinates=null,this.currentDateTime="",this.viewMode=!1,this.currentUser=null,this.currentReportId="",this.loadedReport=null,this.gpsFromLocation=!1,this.greyWaterPhoto="",this.trashPhoto="",this.sewagePhoto="",this.autosaveSub=null,this.isDiscarded=!1,this.isSubmitted=!1,this.isSubmitting=!1,this.isEditMode=!1,this.originalSubmittedBy="",this.availableLocations=[{name:"Ramsar",hasZones:!0,hasQuads:!0,zones:["1","2","3","4","5","6"],quads:Array.from({length:30},(R,D)=>`quad${D+1}`),zoneQuadMap:{1:[1,2,3],2:[13,14,15,16,17,18,20,21,22,23,25,27,28,29],3:[19,26],4:[4,5],5:[6,7,11,12,24,30],6:[8,9,10]}},{name:"Grand Anse",hasZones:!0,hasQuads:!0,zones:["1","2","3","4"],quads:Array.from({length:22},(R,D)=>`ga${D+1}`),zoneQuadMap:{1:[1,2,3,4],2:[5,6,7,8,9,10,21,22],3:[11,12,13,14,15,16,17,18],4:[19,20]}},{name:"Caiman",hasZones:!1,hasQuads:!0,zones:[],quads:["quad1","quad2","quad3","quad4","quad5"]},{name:"Canopy",hasZones:!1,hasQuads:!0,zones:[],quads:["quad1","quad2","quad3","quad4"]},{name:"Petit Barbarons",hasZones:!0,hasQuads:!1,zones:["1","2","3","4"],quads:[]},{name:"Kempinski",hasZones:!1,hasQuads:!1,zones:[],quads:[]},{name:"Roche Caiman",hasZones:!1,hasQuads:!1,zones:[],quads:[]}]}ngOnInit(){var t=this;return(0,_.A)(function*(){t.currentUser=t.auth.getCurrentUser(),t.initializeForm(),t.setCurrentDateTime(),yield t.loadDynamicSites();const o=t.route.snapshot.queryParams;"true"===o.viewMode&&o.reportId?yield t.loadReportForViewing(o.reportId):(t.route.queryParams.subscribe(n=>{n.location&&t.pollutionForm.patchValue({location:n.location}),n.zone&&t.pollutionForm.patchValue({zoneNumber:n.zone}),n.quad&&t.pollutionForm.patchValue({quadNumber:n.quad}),n.lat&&n.lng&&(t.coordinates={latitude:parseFloat(n.lat),longitude:parseFloat(n.lng)},t.gpsFromLocation=!0,t.updateProgress())}),"true"!==o.fresh&&(yield t.restoreDraftIfAny(),t.setCurrentDateTime()),t.currentReportId||(t.currentReportId=t.pollutionSyncService.generateReportId()),t.subscribeToFormChanges(),navigator.onLine&&t.pollutionSyncService.processPendingQueue().catch(n=>{console.error("PollutionPage: processPendingQueue failed:",n)}))})()}ngOnDestroy(){this.autosaveSub&&(this.autosaveSub.unsubscribe(),this.autosaveSub=null),this.isSubmitted||this.saveDraftOnExit().catch(t=>console.error("PollutionPage: saveDraftOnExit failed:",t))}setCurrentDateTime(t){if(this.pollutionForm){const f=this.pollutionForm.get("reportDate")?.value,x=this.pollutionForm.get("observationTime")?.value;if(f&&x){const[y,F,O]=f.split("-"),[S,R]=x.split(":");return void(this.currentDateTime=`${O}/${F}/${y}  \u2022  ${S}:${R}`)}}if(t){const f=this.extractDateTimeFromReportId(t);if(f)return void(this.currentDateTime=f)}const o=new Date,n=String(o.getDate()).padStart(2,"0"),i=String(o.getMonth()+1).padStart(2,"0"),l=o.getFullYear(),h=String(o.getHours()).padStart(2,"0"),v=String(o.getMinutes()).padStart(2,"0");this.currentDateTime=`${n}/${i}/${l}  \u2022  ${h}:${v}`}extractDateTimeFromReportId(t){const o=t.match(/(\d{2})(\d{2})(\d{4})_(\d{2})(\d{2})(\d{2})/);if(o){const[,n,i,l,h,v]=o;return`${n}/${i}/${l}  \u2022  ${h}:${v}`}return null}getCurrentDate(){return(new Date).toISOString().split("T")[0]}initializeForm(){const t=this.getCurrentDate(),o=new Date,n=`${String(o.getHours()).padStart(2,"0")}:${String(o.getMinutes()).padStart(2,"0")}`;this.pollutionForm=this.formBuilder.group({reportDate:[t,k.k0.required],observationTime:[n],location:["",k.k0.required],zoneNumber:[""],quadNumber:[""],greyWaterDumping:[!1],dumpingTrash:[[]],sewageDischarge:[!1],description:["",k.k0.required],possibleSource:[""],requiresUrgentAction:[!1]}),this.updateProgress()}editLocation(){var t=this;return(0,_.A)(function*(){yield(yield t.alertController.create({header:"Location/Site",inputs:[{name:"location",type:"text",placeholder:"Enter location",value:t.pollutionForm.get("location")?.value||""}],buttons:[{text:"Cancel",role:"cancel"},{text:"Save",handler:n=>{t.pollutionForm.patchValue({location:n.location})}}]})).present()})()}editZone(){var t=this;return(0,_.A)(function*(){yield(yield t.alertController.create({header:"Zone Number",inputs:[{name:"zoneNumber",type:"text",placeholder:"Enter zone number",value:t.pollutionForm.get("zoneNumber")?.value||""}],buttons:[{text:"Cancel",role:"cancel"},{text:"Save",handler:n=>{t.pollutionForm.patchValue({zoneNumber:n.zoneNumber})}}]})).present()})()}editQuad(){var t=this;return(0,_.A)(function*(){yield(yield t.alertController.create({header:"Quad Number",inputs:[{name:"quadNumber",type:"text",placeholder:"Enter quad number",value:t.pollutionForm.get("quadNumber")?.value||""}],buttons:[{text:"Cancel",role:"cancel"},{text:"Save",handler:n=>{t.pollutionForm.patchValue({quadNumber:n.quadNumber})}}]})).present()})()}getZoneName(t){return t?`Zone ${t}`:""}getQuadDisplay(t){if(!t)return"";const o=t.match(/\d+/);return o?o[0]:""}locationHasZones(){const t=this.pollutionForm.get("location")?.value;return!!t&&["Ramsar","Grand Anse","Petit Barbarons"].includes(t)}locationHasQuads(){const t=this.pollutionForm.get("location")?.value;return!!t&&["Ramsar","Grand Anse","Caiman","Canopy"].includes(t)}editLocationAdmin(){var t=this;return(0,_.A)(function*(){if(!t.currentUser||t.currentUser.level<4)return;const o=yield t.selectLocationStep();if(!o)return;const n=t.availableLocations.find(h=>h.name===o);let i="";if(n?.hasZones&&n.zones.length>0){const h=yield t.selectZoneStep(n);if(null===h)return;i=h}let l="";if(n?.hasQuads&&n.quads.length>0){const h=yield t.selectQuadStep(n,i);if(null===h)return;l=h}t.pollutionForm.patchValue({location:o,zoneNumber:i,quadNumber:l}),t.isEditMode&&t.pollutionForm.markAsDirty()})()}selectLocationStep(){var t=this;return new Promise(function(){var o=(0,_.A)(function*(n){const i=t.pollutionForm.get("location")?.value||"",l=t.availableLocations.map(v=>({name:"location",type:"radio",label:v.name,value:v.name,checked:v.name===i}));yield(yield t.alertController.create({header:"Select Location",cssClass:"location-edit-alert",inputs:l,buttons:[{text:"Cancel",role:"cancel",handler:()=>n(null)},{text:"Next",handler:v=>n(v)}]})).present()});return function(n){return o.apply(this,arguments)}}())}selectZoneStep(t){var o=this;return new Promise(function(){var n=(0,_.A)(function*(i){const l=o.pollutionForm.get("zoneNumber")?.value||"",h=t.zones.map(f=>({name:"zone",type:"radio",label:`Zone ${f}`,value:f,checked:f===l}));yield(yield o.alertController.create({header:"Select Zone",subHeader:t.name,cssClass:"location-edit-alert",inputs:h,buttons:[{text:"Cancel",role:"cancel",handler:()=>i(null)},{text:"Next",handler:f=>i(f)}]})).present()});return function(i){return n.apply(this,arguments)}}())}selectQuadStep(t,o){var n=this;return new Promise(function(){var i=(0,_.A)(function*(l){const h=n.pollutionForm.get("quadNumber")?.value||"";let v=t.quads;if(o&&t.zoneQuadMap&&t.zoneQuadMap[o]){const y=t.zoneQuadMap[o];v=t.quads.filter(F=>{const O=parseInt(n.getQuadDisplay(F));return y.includes(O)})}const f=v.map(y=>({name:"quad",type:"radio",label:`Quad ${n.getQuadDisplay(y)}`,value:y,checked:n.getQuadDisplay(y)===h||y===h}));yield(yield n.alertController.create({header:"Select Quad",subHeader:t.name,cssClass:"location-edit-alert",inputs:f,buttons:[{text:"Cancel",role:"cancel",handler:()=>l(null)},{text:"Save",handler:y=>l(y)}]})).present()});return function(l){return i.apply(this,arguments)}}())}loadDynamicSites(){var t=this;return(0,_.A)(function*(){try{(yield t.siteSyncService.getAllSites()).forEach(n=>{t.availableLocations.some(i=>i.name===n.name)||t.availableLocations.push({name:n.name,hasZones:n.zones&&n.zones.length>0||!1,hasQuads:n.sample_points&&n.sample_points.length>0||!1,zones:n.zones?n.zones.map(i=>i.name?.replace("Zone ","")||i.id):[],quads:n.sample_points?n.sample_points.map(i=>i.id||i.label):[]})})}catch(o){console.error("Error loading dynamic sites:",o)}})()}getGPSCoordinates(){var t=this;return(0,_.A)(function*(){try{const o=yield t.loadingController.create({message:"Getting GPS coordinates..."});yield o.present();const n=yield j.L.getCurrentPosition({enableHighAccuracy:!0,timeout:15e3,maximumAge:0});t.coordinates={latitude:n.coords.latitude,longitude:n.coords.longitude},yield t.saveDraftOnExit(),yield o.dismiss(),t.updateProgress(),yield(yield t.alertController.create({header:"GPS Captured",message:`Location: ${t.coordinates.latitude.toFixed(6)}, ${t.coordinates.longitude.toFixed(6)}`,buttons:["OK"]})).present()}catch(o){console.error("Error getting GPS coordinates:",o);let n="Failed to get GPS coordinates. Please ensure location services are enabled and try again.";o instanceof Error&&(o.message.includes("Location services are not enabled")?n="Location services are disabled. Please enable GPS/location services on your device.":o.message.includes("User denied")?n="Location permission was denied. Please enable location access for this app in your device settings.":o.message.includes("timeout")&&(n="GPS signal timeout. Please try again with a clear view of the sky.")),yield(yield t.alertController.create({header:"GPS Error",message:n,buttons:["OK"]})).present()}})()}capturePhoto(){var t=this;return(0,_.A)(function*(){if(t.photos.length>=5)yield(yield t.alertController.create({header:"Maximum Photos",message:"You can only add up to 5 photos.",buttons:["OK"]})).present();else try{const o=yield t.photoService.TakePicture();o?(t.photos.push(o),t.updateProgress(),yield t.saveDraftOnExit()):yield(yield t.alertController.create({header:"Photo Error",message:"Failed to capture photo",buttons:["OK"]})).present()}catch(o){console.error("Error capturing photo:",o),yield(yield t.alertController.create({header:"Photo Error",message:"Failed to capture photo",buttons:["OK"]})).present()}})()}removePhoto(t){this.photos.splice(t,1),this.updateProgress(),this.saveDraftOnExit().catch(o=>console.error("PollutionPage: saveDraftOnExit failed:",o))}captureIndividualPhoto(t){var o=this;return(0,_.A)(function*(){try{const n=yield o.photoService.TakePicture();if(n){switch(t){case"greyWater":o.greyWaterPhoto=n;break;case"trash":o.trashPhoto=n;break;case"sewage":o.sewagePhoto=n}o.updateProgress(),yield o.saveDraftOnExit()}else yield(yield o.alertController.create({header:"Photo Error",message:"Failed to capture photo",buttons:["OK"]})).present()}catch(n){console.error("Error capturing photo:",n),yield(yield o.alertController.create({header:"Photo Error",message:"Failed to capture photo",buttons:["OK"]})).present()}})()}removeIndividualPhoto(t){switch(t){case"greyWater":this.greyWaterPhoto="";break;case"trash":this.trashPhoto="";break;case"sewage":this.sewagePhoto=""}this.updateProgress(),this.saveDraftOnExit().catch(o=>console.error("PollutionPage: saveDraftOnExit failed:",o))}showGreyWaterInfo(t){var o=this;return(0,_.A)(function*(){yield(yield o.alertController.create({header:"Grey Water",message:"Grey water is wastewater from household activities such as laundry, dishwashing, and bathing. It may contain traces of soap, detergent, food particles, and other contaminants.",buttons:["OK"]})).present()})()}updateProgress(){const t=this.pollutionForm.value;let o=0,n=2;t.location&&o++,t.description&&o++,this.coordinates&&(o++,n++),this.photos.length>0&&(o++,n++),t.possibleSource&&(o++,n++),this.progress=n>0?o/n:0}subscribeToFormChanges(){this.autosaveSub&&this.autosaveSub.unsubscribe(),this.autosaveSub=this.pollutionForm.valueChanges.pipe((0,G.B)(750)).subscribe(()=>{this.isSubmitted||(this.updateProgress(),this.saveDraftOnExit().catch(t=>console.error("PollutionPage: autosave failed:",t)))})}onSubmit(){var t=this;return(0,_.A)(function*(){if(t.isSubmitting)return;if(t.isSubmitting=!0,t.pollutionForm.markAllAsTouched(),!t.pollutionForm.valid)return t.isSubmitting=!1,void(yield(yield t.alertController.create({header:"Incomplete Form",message:"Please fill in all required fields (Location, Date, and Description).",buttons:["OK"]})).present());t.isSubmitted=!0,t.autosaveSub&&(t.autosaveSub.unsubscribe(),t.autosaveSub=null);const o=yield t.loadingController.create({message:"Submitting pollution report..."});yield o.present();try{const n={...t.pollutionForm.value};n.status={incomplete:!1,sent:!0,pending:!1};const i={formValue:n,coordinates:t.coordinates,photos:{general:t.photos,greyWater:t.greyWaterPhoto,trash:t.trashPhoto,sewage:t.sewagePhoto},existingReportId:t.currentReportId||void 0};t.isEditMode&&(i.isEditMode=!0,i.originalSubmittedBy=t.originalSubmittedBy);const l=yield t.pollutionSyncService.submitFinal(i);yield o.dismiss();try{t.autosaveSub&&(t.autosaveSub.unsubscribe(),t.autosaveSub=null),yield new Promise(S=>setTimeout(S,1e3));const f=t.pollutionForm.value;yield t.pollutionSyncService.clearDraft(f);const x=(f?.location||"unknown").replace(/[^a-zA-Z0-9]/g,"_"),y=f?.zoneNumber||"",F=f?.quadNumber||"";let O=`pollution_draft_${x}`;y&&(O+=`_zone${y}`),F&&(O+=`_quad${F}`),yield t.forceDeleteDraftFile(`${O}.json`),t.isSubmitted=!0,console.log("PollutionPage: Draft cleared and form reset successfully")}catch(f){console.error("PollutionPage: Failed to clear draft:",f)}const h=t.isEditMode?l.queued?"Updated report saved locally and queued for upload when online.":"Pollution report updated successfully!":l.queued?"Pollution report saved locally and queued for upload when online.":"Pollution report submitted successfully!";yield(yield t.alertController.create({header:"Success",message:h,buttons:[{text:"OK",handler:()=>{t.router.navigate(["/threats"])}}]})).present()}catch(n){yield o.dismiss(),console.error("Error submitting report:",n),yield(yield t.alertController.create({header:"Error",message:"Failed to submit pollution report. Please try again.",buttons:["OK"]})).present()}})()}discardForm(){var t=this;return(0,_.A)(function*(){var n;yield(yield t.alertController.create({header:"Discard Form",message:"Are you sure you want to discard this form? All entered data will be lost.",buttons:[{text:"Cancel",role:"cancel"},{text:"Discard",role:"destructive",handler:(n=(0,_.A)(function*(){t.isDiscarded=!0,t.autosaveSub&&(t.autosaveSub.unsubscribe(),t.autosaveSub=null),yield new Promise(x=>setTimeout(x,1e3));const i=t.pollutionForm.value;yield t.pollutionSyncService.clearDraft(i);const l=(i?.location||"unknown").replace(/[^a-zA-Z0-9]/g,"_"),h=i?.zoneNumber||"",v=i?.quadNumber||"";let f=`pollution_draft_${l}`;h&&(f+=`_zone${h}`),v&&(f+=`_quad${v}`),yield t.forceDeleteDraftFile(`${f}.json`),yield new Promise(x=>setTimeout(x,200)),t.initializeForm(),t.router.navigate(["/threats"])}),function(){return n.apply(this,arguments)})}]})).present()})()}restoreDraftIfAny(){var t=this;return(0,_.A)(function*(){const o=t.route.snapshot.queryParams,n={location:o.location||t.pollutionForm.get("location")?.value,zoneNumber:o.zone||t.pollutionForm.get("zoneNumber")?.value,quadNumber:o.quad||t.pollutionForm.get("quadNumber")?.value},i=yield t.pollutionSyncService.loadDraft(n);if(i)try{i.reportId&&(t.currentReportId=i.reportId),i.form&&t.pollutionForm.patchValue(i.form),t.coordinates=i.coordinates||null,t.photos=Array.isArray(i.photos?.general)?i.photos.general:[],t.greyWaterPhoto=i.photos?.greyWater||"",t.trashPhoto=i.photos?.trash||"",t.sewagePhoto=i.photos?.sewage||"",t.updateProgress()}catch(l){console.error("PollutionPage: failed to restore draft:",l)}})()}saveDraft(){var t=this;return(0,_.A)(function*(){var n;t.pollutionForm&&(yield(yield t.alertController.create({header:"Save Draft",message:"Are you sure you want to save this form as a draft? You can return to complete it later.",buttons:[{text:"Cancel",role:"cancel"},{text:"Save Draft",handler:(n=(0,_.A)(function*(){try{yield t.saveDraftOnExit(),yield(yield t.alertController.create({header:"Draft Saved",message:"Your form has been saved as a draft. You can access it from the threats page.",buttons:[{text:"OK",handler:()=>{t.router.navigate(["/threats"])}}]})).present()}catch(i){console.error("Failed to save draft:",i),yield(yield t.alertController.create({header:"Save Failed",message:"Failed to save the draft. Please try again.",buttons:["OK"]})).present()}}),function(){return n.apply(this,arguments)})}]})).present())})()}saveDraftOnExit(){var t=this;return(0,_.A)(function*(){if(!t.pollutionForm||t.viewMode||t.isDiscarded||t.isSubmitted)return;const o=t.pollutionForm.value;(o?.location||o?.description||t.coordinates||t.photos&&t.photos.length>0||t.greyWaterPhoto||t.trashPhoto||t.sewagePhoto)&&(yield t.pollutionSyncService.saveDraft({reportId:t.currentReportId,form:o,coordinates:t.coordinates,photos:{general:t.photos,greyWater:t.greyWaterPhoto||null,trash:t.trashPhoto||null,sewage:t.sewagePhoto||null}}))})()}setViewMode(t){this.viewMode=t,t?(this.pollutionForm.disable(),this.enableToggleAndCheckboxControls()):this.pollutionForm.enable()}enableEditMode(){!this.currentUser||this.currentUser.level<4||(this.isEditMode=!0,this.viewMode=!1,this.pollutionForm.enable(),this.originalSubmittedBy=this.loadedReport?.submittedBy||"")}getEditedDateTime(){if(!this.loadedReport)return null;let t=this.loadedReport.editedAt||null;if(!t){const f=this.loadedReport.updatedAt,x=this.loadedReport.createdAt;f&&x&&f!==x&&Math.abs(new Date(f).getTime()-new Date(x).getTime())>5e3&&(t=f)}if(!t)return null;const o=new Date(t);return isNaN(o.getTime())?null:`${o.getDate().toString().padStart(2,"0")}/${(o.getMonth()+1).toString().padStart(2,"0")}/${o.getFullYear()} ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}`}enableToggleAndCheckboxControls(){this.pollutionForm.get("greyWaterDumping")?.enable(),this.pollutionForm.get("sewageDischarge")?.enable(),this.pollutionForm.get("requiresUrgentAction")?.enable()}loadReportForViewing(t){var o=this;return(0,_.A)(function*(){try{const n=yield o.pollutionSyncService.getAllReports();console.log("PollutionPage: All reports:",n);const i=n.find(h=>h.report.reportId===t);if(!i)return console.error("PollutionPage: Report not found for viewing:",t),yield(yield o.alertController.create({header:"Report Not Found",message:"The requested report could not be found.",buttons:["OK"]})).present(),void o.router.navigate(["/threats"]);const l=i.report;console.log("PollutionPage: Loading report for viewing:",l),o.loadedReport=l,o.pollutionForm.patchValue({reportDate:l.form.reportDate||l.form.date||"",observationTime:l.form.observationTime||"",location:l.form.location||"",zoneNumber:l.form.zoneNumber||"",quadNumber:l.form.quadNumber||"",greyWaterDumping:l.form.greyWaterDumping||!1,dumpingTrash:l.form.dumpingTrash||[],sewageDischarge:l.form.sewageDischarge||!1,description:l.form.description||"",possibleSource:l.form.possibleSource||"",requiresUrgentAction:l.form.requiresUrgentAction||!1}),l.coordinates&&(o.coordinates=l.coordinates),l.photos&&(l.photos.general&&Array.isArray(l.photos.general)&&(o.photos=l.photos.general.map(h=>(h.startsWith("data:image/")||console.warn("\u26a0\ufe0f PollutionPage: General photo is not base64:",h.substring(0,50)),h))),l.photos.greyWater&&(l.photos.greyWater.startsWith("data:image/")||console.warn("\u26a0\ufe0f PollutionPage: GreyWater photo is not base64:",l.photos.greyWater.substring(0,50)),o.greyWaterPhoto=l.photos.greyWater),l.photos.trash&&(l.photos.trash.startsWith("data:image/")||console.warn("\u26a0\ufe0f PollutionPage: Trash photo is not base64:",l.photos.trash.substring(0,50)),o.trashPhoto=l.photos.trash),l.photos.sewage&&(l.photos.sewage.startsWith("data:image/")||console.warn("\u26a0\ufe0f PollutionPage: Sewage photo is not base64:",l.photos.sewage.substring(0,50)),o.sewagePhoto=l.photos.sewage)),o.currentReportId=t,o.setCurrentDateTime(t),o.updateProgress(),o.setViewMode(!0)}catch(n){console.error("PollutionPage: Error loading report for viewing:",n),yield(yield o.alertController.create({header:"Error",message:"Failed to load the report.",buttons:["OK"]})).present(),o.router.navigate(["/threats"])}})()}deleteEntry(){var t=this;return(0,_.A)(function*(){const o=t.auth.getCurrentUser();var i;!o||o.level<4?yield(yield t.alertController.create({header:"Permission Denied",message:"Only Level 4 users can delete entries.",buttons:["OK"]})).present():yield(yield t.alertController.create({header:"Delete Entry",message:"Are you sure you want to permanently delete this entry? This will remove it from the database and back it up to deleted files storage. This action cannot be undone.",buttons:[{text:"Cancel",role:"cancel"},{text:"Delete",role:"destructive",handler:(i=(0,_.A)(function*(){yield t.performDeletion()}),function(){return i.apply(this,arguments)})}]})).present()})()}performDeletion(){var t=this;return(0,_.A)(function*(){const o=yield t.loadingController.create({message:"Deleting entry..."});yield o.present();try{const n=t.auth.getCurrentUser();yield t.entryDeletionService.deleteEntry({reportId:t.currentReportId,formType:"pollution",tableName:"pollution_reports",deletedBy:n?.username||"Unknown",deletedByEmail:n?.email||"",originalSubmittedBy:t.loadedReport?.submittedBy,originalSubmittedAt:t.loadedReport?.createdAt}),yield o.dismiss(),yield(yield t.alertController.create({header:"Success",message:"Entry has been deleted and backed up successfully.",buttons:[{text:"OK",handler:()=>{t.router.navigate(["/threats"])}}]})).present()}catch(n){yield o.dismiss(),console.error("Error deleting entry:",n),yield(yield t.alertController.create({header:"Error",message:"Failed to delete entry. Please try again.",buttons:["OK"]})).present()}})()}openFullScreenPhoto(t,o){var n=this;return(0,_.A)(function*(){yield(yield n.modalController.create({component:pe,componentProps:{photoUrl:t,photoType:o},cssClass:"fullscreen-photo-modal"})).present()})()}static#e=r=()=>(this.\u0275fac=function(o){return new(o||p)(e.rXU(k.ok),e.rXU(g.hG),e.rXU(g.Xi),e.rXU(g.W3),e.rXU(T.Ix),e.rXU(T.nX),e.rXU(g.IE),e.rXU(a.N),e.rXU(m.T),e.rXU(c.I),e.rXU(u.H),e.rXU(P.C),e.rXU(M.k))},this.\u0275cmp=e.VBU({type:p,selectors:[["app-pollution"]],standalone:!1,decls:134,vars:42,consts:[[1,"coral"],["slot","start"],["defaultHref","/threats"],[1,"coral","compact-toolbar"],[1,"date-time-text"],[4,"ngIf"],[1,"coral","metadata-toolbar"],[1,"metadata-container"],[1,"metadata-item",3,"click"],["name","location",1,"metadata-icon"],[1,"metadata-label"],["name","alert-circle","class","status-icon required",4,"ngIf"],["class","metadata-item",3,"click",4,"ngIf"],["class","edit-location-link",3,"click",4,"ngIf"],["style","padding: 0 16px; font-size: 0.75rem; color: #e76f51;",4,"ngIf"],["color","light",3,"value"],[1,"progress-text"],[3,"ngSubmit","formGroup"],["class","edit-mode-banner",4,"ngIf"],["class","edit-mode-banner editing",4,"ngIf"],[1,"gps-card"],["lines","none",1,"gps-item",3,"click","button"],["slot","start",1,"gps-icon-container"],["name","navigate",3,"color"],[1,"gps-title"],["class","gps-hint",4,"ngIf"],["class","coordinates-text",4,"ngIf"],["class","gps-source-hint",4,"ngIf"],[1,"disturbance-item"],[1,"disturbance-title"],["name","information-circle-outline",1,"info-icon",3,"click"],["lines","none",1,"toggle-item"],[1,"toggle-labels"],[1,"toggle-no",3,"hidden"],["formControlName","greyWaterDumping",1,"coastal-toggle"],[1,"toggle-yes",3,"hidden"],[1,"inline-photo-section"],["size","small","class","coastal-button",3,"click",4,"ngIf"],["class","photo-preview-only",4,"ngIf"],["formControlName","sewageDischarge",1,"coastal-toggle"],["position","stacked"],["formControlName","dumpingTrash","multiple","true","placeholder","Select type(s)","interface","popover"],["value","plastics"],["value","metal"],["value","glass"],["value","fabric"],["value","paper_cardboard"],["value","home_appliance"],["value","construction_debris"],["value","furniture"],[1,"inline-photo-section","centered"],[1,"photos-container"],["class","photo-item",4,"ngFor","ngForOf"],["expand","block","fill","outline","class","add-photo-button",3,"click",4,"ngIf"],[2,"position","relative"],["formControlName","description","rows","6","placeholder","Provide a detailed description of the pollution observed, including any potential sources, visible impacts on wildlife or vegetation, and any other relevant information."],["name","close-circle","color","danger","style","position: absolute; top: 12px; right: 10px;",4,"ngIf"],["name","checkmark-circle","style","position: absolute; top: 12px; right: 10px; color: #52a676;",4,"ngIf"],["formControlName","possibleSource","type","text","placeholder","Enter possible pollution source"],["lines","none"],["formControlName","requiresUrgentAction","slot","start"],["class","form-buttons",4,"ngIf"],["class","button-container",4,"ngIf"],["name","alert-circle",1,"status-icon","required"],["name","grid",1,"metadata-icon"],["name","apps",1,"metadata-icon"],[1,"edit-location-link",3,"click"],[2,"padding","0 16px","font-size","0.75rem","color","#e76f51"],[1,"edit-mode-banner"],["expand","block","color","warning",3,"click"],["name","create-outline","slot","start"],[1,"edit-mode-banner","editing"],["name","create-outline"],[1,"gps-hint"],["name","location","size","small"],[1,"coordinates-text"],["name","pin","size","small"],[1,"gps-source-hint"],["name","information-circle","size","small"],["size","small",1,"coastal-button",3,"click"],["name","camera","slot","start"],[1,"photo-preview-only"],[1,"photo-wrapper"],["alt","Grey water photo",2,"cursor","pointer",3,"click","src"],[1,"click-hint"],["size","small","color","danger",3,"click",4,"ngIf"],["size","small","color","danger",3,"click"],["name","trash","slot","icon-only"],["alt","Sewage photo",2,"cursor","pointer",3,"click","src"],["alt","Trash photo",2,"cursor","pointer",3,"click","src"],[1,"photo-item"],[2,"cursor","pointer",3,"click","src","alt"],["expand","block","fill","outline",1,"add-photo-button",3,"click"],["name","close-circle","color","danger",2,"position","absolute","top","12px","right","10px"],["name","checkmark-circle",2,"position","absolute","top","12px","right","10px","color","#52a676"],[1,"form-buttons"],["expand","block","type","submit",1,"submit-button",3,"disabled"],["name","checkmark-circle","slot","start"],["expand","block","fill","outline","color","medium",1,"save-draft-button",3,"click"],["name","save-outline","slot","start"],["expand","block","fill","outline",1,"discard-button",3,"click"],["name","trash-outline","slot","start"],[1,"button-container"],["expand","block","color","danger",1,"delete-button",3,"click"]],template:function(o,n){if(1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1),e.nrm(3,"ion-back-button",2),e.k0s(),e.j41(4,"ion-title"),e.EFF(5,"Pollution Report"),e.k0s()(),e.j41(6,"ion-toolbar",3)(7,"ion-text",4),e.EFF(8),e.DNE(9,w,2,1,"span",5),e.k0s()(),e.j41(10,"ion-toolbar",6)(11,"div",7)(12,"div",8),e.bIt("click",function(){return!n.viewMode&&n.editLocation()}),e.nrm(13,"ion-icon",9),e.j41(14,"span",10),e.EFF(15),e.k0s(),e.DNE(16,E,1,0,"ion-icon",11),e.k0s(),e.DNE(17,W,4,1,"div",12)(18,U,4,1,"div",12)(19,$,2,0,"span",13),e.k0s(),e.DNE(20,A,2,0,"ion-error",14),e.k0s(),e.j41(21,"ion-toolbar",3),e.nrm(22,"ion-progress-bar",15),e.j41(23,"ion-text",16),e.EFF(24),e.k0s()()(),e.j41(25,"ion-content")(26,"form",17),e.bIt("ngSubmit",function(){return n.onSubmit()}),e.DNE(27,B,4,0,"div",18)(28,z,4,0,"div",19),e.j41(29,"ion-card",20)(30,"ion-card-header",0)(31,"ion-card-title"),e.EFF(32,"GPS Coordinates"),e.k0s()(),e.j41(33,"ion-card-content")(34,"ion-item",21),e.bIt("click",function(){return!n.viewMode&&n.getGPSCoordinates()}),e.j41(35,"div",22),e.nrm(36,"ion-icon",23),e.k0s(),e.j41(37,"ion-label")(38,"h3",24),e.EFF(39),e.k0s(),e.DNE(40,V,3,0,"p",25)(41,q,3,2,"p",26)(42,L,3,0,"p",27),e.k0s()()()(),e.j41(43,"ion-card")(44,"ion-card-header",0)(45,"ion-card-title"),e.EFF(46,"Pollution Types"),e.k0s()(),e.j41(47,"ion-card-content")(48,"div",28)(49,"div",29),e.EFF(50," Grey water dumping "),e.j41(51,"ion-icon",30),e.bIt("click",function(l){return n.showGreyWaterInfo(l)}),e.k0s()(),e.j41(52,"ion-item",31)(53,"div",32)(54,"span",33),e.EFF(55,"No"),e.k0s(),e.nrm(56,"ion-toggle",34),e.j41(57,"span",35),e.EFF(58,"Yes"),e.k0s()(),e.j41(59,"div",36),e.DNE(60,X,3,0,"ion-button",37),e.k0s()(),e.DNE(61,K,6,2,"div",38),e.k0s(),e.nrm(62,"ion-item-divider"),e.j41(63,"div",28)(64,"div",29),e.EFF(65,"Sewage discharge"),e.k0s(),e.j41(66,"ion-item",31)(67,"div",32)(68,"span",33),e.EFF(69,"No"),e.k0s(),e.nrm(70,"ion-toggle",39),e.j41(71,"span",35),e.EFF(72,"Yes"),e.k0s()(),e.j41(73,"div",36),e.DNE(74,Z,3,0,"ion-button",37),e.k0s()(),e.DNE(75,J,6,2,"div",38),e.k0s(),e.nrm(76,"ion-item-divider"),e.j41(77,"div",28)(78,"div",29),e.EFF(79,"Dumping of Trash"),e.k0s(),e.j41(80,"ion-item"),e.nrm(81,"ion-label",40),e.j41(82,"ion-select",41)(83,"ion-select-option",42),e.EFF(84,"Plastics"),e.k0s(),e.j41(85,"ion-select-option",43),e.EFF(86,"Metal"),e.k0s(),e.j41(87,"ion-select-option",44),e.EFF(88,"Glass"),e.k0s(),e.j41(89,"ion-select-option",45),e.EFF(90,"Fabric"),e.k0s(),e.j41(91,"ion-select-option",46),e.EFF(92,"Paper/Cardboard"),e.k0s(),e.j41(93,"ion-select-option",47),e.EFF(94,"Home appliance/electronics"),e.k0s(),e.j41(95,"ion-select-option",48),e.EFF(96,"Construction debris"),e.k0s(),e.j41(97,"ion-select-option",49),e.EFF(98,"Furniture"),e.k0s()()(),e.j41(99,"div",50),e.DNE(100,ee,3,0,"ion-button",37),e.k0s(),e.DNE(101,oe,6,2,"div",38),e.k0s()()(),e.j41(102,"ion-card")(103,"ion-card-header",0)(104,"ion-card-title"),e.EFF(105,"Photo Evidence"),e.k0s(),e.j41(106,"ion-card-subtitle"),e.EFF(107,"Take photos of the pollution (up to 5 photos)"),e.k0s()(),e.j41(108,"ion-card-content")(109,"div",51),e.DNE(110,ie,6,4,"div",52)(111,re,3,1,"ion-button",53),e.k0s()()(),e.j41(112,"ion-card")(113,"ion-card-header",0)(114,"ion-card-title"),e.EFF(115,"Detailed Description"),e.k0s()(),e.j41(116,"ion-card-content")(117,"ion-item",54)(118,"ion-label",40),e.EFF(119,"Description"),e.k0s(),e.nrm(120,"ion-textarea",55),e.DNE(121,ae,1,0,"ion-icon",56)(122,le,1,0,"ion-icon",57)(123,se,2,0,"ion-error",5),e.k0s(),e.j41(124,"ion-item")(125,"ion-label",40),e.EFF(126,"Possible Source (if known)"),e.k0s(),e.nrm(127,"ion-input",58),e.k0s(),e.j41(128,"ion-item",59),e.nrm(129,"ion-checkbox",60),e.j41(130,"ion-label"),e.EFF(131,"This requires urgent action"),e.k0s()()()(),e.DNE(132,ce,10,1,"div",61)(133,de,4,0,"div",62),e.k0s()()),2&o){let i,l,h,v,f,x,y,F,O,S,R,D;e.R7$(8),e.SpI(" ",n.currentDateTime),e.R7$(),e.Y8G("ngIf",(n.viewMode||n.isEditMode)&&n.getEditedDateTime()),e.R7$(6),e.JRh((null==(i=n.pollutionForm.get("location"))?null:i.value)||"Add location"),e.R7$(),e.Y8G("ngIf",!(null!=(l=n.pollutionForm.get("location"))&&l.value||n.viewMode)),e.R7$(),e.Y8G("ngIf",(null==(h=n.pollutionForm.get("zoneNumber"))?null:h.value)&&n.locationHasZones()),e.R7$(),e.Y8G("ngIf",(null==(v=n.pollutionForm.get("quadNumber"))?null:v.value)&&n.locationHasQuads()),e.R7$(),e.Y8G("ngIf",n.isEditMode&&n.currentUser&&n.currentUser.level>=4),e.R7$(),e.Y8G("ngIf",(null==(f=n.pollutionForm.get("location"))?null:f.hasError("required"))&&(null==(f=n.pollutionForm.get("location"))?null:f.touched)),e.R7$(2),e.Y8G("value",n.progress),e.R7$(2),e.SpI(" ",(100*n.progress).toFixed(0),"% Complete "),e.R7$(),e.AVh("view-mode",n.viewMode),e.R7$(),e.Y8G("formGroup",n.pollutionForm),e.R7$(),e.Y8G("ngIf",n.viewMode&&n.currentUser&&n.currentUser.level>=4),e.R7$(),e.Y8G("ngIf",n.isEditMode),e.R7$(6),e.AVh("gps-captured",n.coordinates),e.Y8G("button",!n.viewMode),e.R7$(2),e.Y8G("color",n.coordinates?"success":"medium"),e.R7$(3),e.SpI(" ",n.coordinates?n.gpsFromLocation?"GPS Location from New Site":"GPS Location Captured":"Capture GPS Location"," "),e.R7$(),e.Y8G("ngIf",!n.coordinates),e.R7$(),e.Y8G("ngIf",n.coordinates),e.R7$(),e.Y8G("ngIf",n.coordinates&&n.gpsFromLocation),e.R7$(12),e.Y8G("hidden",null==(x=n.pollutionForm.get("greyWaterDumping"))?null:x.value),e.R7$(3),e.Y8G("hidden",!(null!=(y=n.pollutionForm.get("greyWaterDumping"))&&y.value)),e.R7$(3),e.Y8G("ngIf",!n.viewMode),e.R7$(),e.Y8G("ngIf",n.greyWaterPhoto),e.R7$(7),e.Y8G("hidden",null==(F=n.pollutionForm.get("sewageDischarge"))?null:F.value),e.R7$(3),e.Y8G("hidden",!(null!=(O=n.pollutionForm.get("sewageDischarge"))&&O.value)),e.R7$(3),e.Y8G("ngIf",!n.viewMode),e.R7$(),e.Y8G("ngIf",n.sewagePhoto),e.R7$(25),e.Y8G("ngIf",!n.viewMode),e.R7$(),e.Y8G("ngIf",n.trashPhoto),e.R7$(9),e.Y8G("ngForOf",n.photos),e.R7$(),e.Y8G("ngIf",n.photos.length<5&&!n.viewMode),e.R7$(10),e.Y8G("ngIf",!(null!=(S=n.pollutionForm.get("description"))&&S.value)),e.R7$(),e.Y8G("ngIf",null==(R=n.pollutionForm.get("description"))?null:R.value),e.R7$(),e.Y8G("ngIf",(null==(D=n.pollutionForm.get("description"))?null:D.hasError("required"))&&(null==(D=n.pollutionForm.get("description"))?null:D.touched)),e.R7$(5),e.AVh("view-mode-item",n.viewMode),e.R7$(4),e.Y8G("ngIf",!n.viewMode),e.R7$(),e.Y8G("ngIf",n.viewMode&&(null==n.currentUser?null:n.currentUser.level)>=4)}},dependencies:[C.Sq,C.bT,k.qT,k.BC,k.cb,k.j4,k.JD,g.Jm,g.QW,g.b_,g.I9,g.ME,g.HW,g.tN,g.eY,g.W9,g.eU,g.iq,g.$w,g.uz,g.Dg,g.he,g.FH,g.Nm,g.Ip,g.IO,g.nc,g.BC,g.BY,g.ai,g.hB,g.Je,g.Gw,g.el],styles:[".coral[_ngcontent-%COMP%]{--background: #e76f51;color:#fff}.coral[_ngcontent-%COMP%]   ion-back-button[_ngcontent-%COMP%]{--color: white;transition:transform .2s}.coral[_ngcontent-%COMP%]   ion-back-button[_ngcontent-%COMP%]:hover{transform:translate(-4px)}.coral[_ngcontent-%COMP%]   ion-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700;text-align:center}.coral.compact-toolbar[_ngcontent-%COMP%]{--min-height: 28px;--padding-top: 5px;--padding-bottom: 5px}.edit-mode-banner[_ngcontent-%COMP%]{padding:.75rem 1rem;margin:.5rem;border-radius:.5rem}.edit-mode-banner[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: .5rem;font-weight:600}.edit-mode-banner.editing[_ngcontent-%COMP%]{background:#fff3cd;border:1px solid #ffc107;display:flex;align-items:center;gap:.5rem;color:#856404;font-weight:500}.edit-mode-banner.editing[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:1.2rem}.date-time-text[_ngcontent-%COMP%]{display:block;text-align:center;color:#fffffff2;font-size:14px;padding:0;margin:3px 0;font-weight:400;letter-spacing:.3px;line-height:1.2}.metadata-toolbar[_ngcontent-%COMP%]{--min-height: 40px;--padding-top: 6px;--padding-bottom: 6px}.metadata-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;gap:8px;padding:0 12px;flex-wrap:wrap}.metadata-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:5px;background:#ffffff26;border-radius:16px;padding:5px 10px;cursor:pointer;transition:all .2s ease;-webkit-backdrop-filter:blur(10px);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}.metadata-item[_ngcontent-%COMP%]:active{transform:scale(.95);background:#ffffff40}.metadata-icon[_ngcontent-%COMP%]{font-size:14px;color:#ffffffe6;min-width:14px}.metadata-label[_ngcontent-%COMP%]{color:#fff;font-size:12px;font-weight:500;letter-spacing:.2px;white-space:nowrap;max-width:120px;overflow:hidden;text-overflow:ellipsis}.edit-location-link[_ngcontent-%COMP%]{color:#ffffffe6;font-size:11px;text-decoration:underline;cursor:pointer;margin-left:8px;padding:4px 8px}.edit-location-link[_ngcontent-%COMP%]:active{opacity:.7}.status-icon[_ngcontent-%COMP%]{font-size:14px;margin-left:2px}.status-icon.success[_ngcontent-%COMP%]{color:#52a676}.status-icon.required[_ngcontent-%COMP%]{color:#ffd93d;animation:_ngcontent-%COMP%_pulse 2s infinite}@keyframes _ngcontent-%COMP%_pulse{0%,to{opacity:1}50%{opacity:.6}}.progress-text[_ngcontent-%COMP%]{display:block;text-align:center;color:#fff;font-size:13px;padding:0;margin:0 0 4px;font-weight:400;line-height:1}ion-card[_ngcontent-%COMP%]{margin:16px;border-radius:12px;box-shadow:0 2px 8px #0000001a}ion-card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]{border-radius:12px 12px 0 0;padding:16px}ion-card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:700;color:#fff}ion-card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%]{color:#ffffffe6;font-size:.875rem;margin-top:4px}ion-card[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]{background:#fff;padding:16px}.gps-card[_ngcontent-%COMP%]{margin:16px;border-radius:12px;box-shadow:0 2px 8px #0000001a;overflow:hidden}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]{--padding-start: 0;--inner-padding-end: 0;--background: #f8f9fa;--border-radius: 8px;margin:0;border-radius:8px;transition:all .2s ease}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]:hover:not(.item-disabled){--background: #e9ecef;transform:translateY(-1px);box-shadow:0 4px 12px #0000001a}.gps-card[_ngcontent-%COMP%]   .gps-item.gps-captured[_ngcontent-%COMP%]{--background: #e8f5e9;border:1px solid #4caf50}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-icon-container[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;width:40px;height:40px;border-radius:50%;background:#ffffffe6;margin:12px;box-shadow:0 2px 4px #0000001a}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-icon-container[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;color:#333;margin-bottom:4px}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-hint[_ngcontent-%COMP%]{display:flex;align-items:center;color:#666;font-size:.9rem}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-hint[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-right:6px;color:#999}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .coordinates-text[_ngcontent-%COMP%]{display:flex;align-items:center;color:#e76f51!important;font-weight:600;font-family:SF Mono,Monaco,Inconsolata,Roboto Mono,monospace;font-size:.9rem}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .coordinates-text[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-right:6px;color:#e76f51}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-source-hint[_ngcontent-%COMP%]{display:flex;align-items:center;color:#666;font-size:.8rem;font-style:italic;margin-top:4px}.gps-card[_ngcontent-%COMP%]   .gps-item[_ngcontent-%COMP%]   .gps-source-hint[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{margin-right:6px;color:#999}.coordinates-text[_ngcontent-%COMP%]{color:#e76f51!important;font-weight:600;font-family:monospace}.photos-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:12px}.photo-item[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center;gap:12px;padding:12px;background:#f9f9f9;border-radius:8px;border-left:4px solid #e76f51}.photo-item[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:4px}.photo-item[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:120px;height:120px;object-fit:cover;border-radius:8px;border:2px solid #e76f51;transition:transform .2s ease,box-shadow .2s ease;touch-action:manipulation;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}.photo-item[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]:hover{transform:scale(1.05);box-shadow:0 4px 12px #e76f5166}.photo-item[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]:active{transform:scale(.98)}.photo-item[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   .click-hint[_ngcontent-%COMP%]{font-size:10px;color:#999;font-style:italic;text-align:center;white-space:nowrap}.photo-item[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--background: #dc2626;--background-hover: #b91c1c;--background-activated: #b91c1c}.add-photo-button[_ngcontent-%COMP%]{--border-color: #e76f51;--color: #e76f51;margin-top:8px}.add-photo-button[_ngcontent-%COMP%]:hover{--background: rgba(231, 111, 81, .1)}ion-item[_ngcontent-%COMP%]{--padding-start: 0;--inner-padding-end: 0;margin-bottom:12px}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin-bottom:8px}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{font-weight:600;color:#0d3d2f;margin:0}ion-item[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#6b7c7a;font-size:.875rem;margin:4px 0 0}ion-item[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%], ion-item[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%], ion-item[_ngcontent-%COMP%]   ion-select[_ngcontent-%COMP%]{--padding-start: 12px;--padding-end: 12px;border:1px solid #ddd;border-radius:8px;margin-top:4px}ion-item[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]{--padding-top: 12px;--padding-bottom: 12px}ion-item[button][_ngcontent-%COMP%]{cursor:pointer;transition:background-color .2s}ion-item[button][_ngcontent-%COMP%]:hover{--background: rgba(231, 111, 81, .05)}ion-select[_ngcontent-%COMP%]{width:100%}  ion-popover.select-popover{--width: auto;--min-width: 250px;--max-width: 90vw}  ion-popover.select-popover .popover-content{border-radius:12px;box-shadow:0 4px 16px #00000026}  ion-popover.select-popover ion-list{padding:8px 0}  ion-popover.select-popover ion-item{--padding-start: 16px;--padding-end: 16px;--min-height: 44px;font-size:.95rem}  ion-popover.select-popover ion-checkbox{--size: 20px;margin-right:12px;--checkbox-background-checked: #4fb3bf !important;--border-color-checked: #4fb3bf !important;--border-color: #4fb3bf !important;--color-checked: #4fb3bf !important;--checkmark-color: white !important;--background: white !important}  ion-popover.select-popover ion-item.item-checkbox-checked{--color: #4fb3bf}  ion-popover.select-popover ion-item.item-checkbox-checked ion-label{color:#4fb3bf!important;font-weight:500}ion-checkbox[_ngcontent-%COMP%]{--size: 24px;--checkbox-background-checked: #e76f51;--border-color-checked: #e76f51}ion-item-divider[_ngcontent-%COMP%]{--padding-top: 4px;--padding-bottom: 4px;min-height:0;margin:8px 0}.disturbance-item[_ngcontent-%COMP%]{padding:12px 0 0}.disturbance-item[_ngcontent-%COMP%]:not(:last-child){margin-bottom:0}.disturbance-title[_ngcontent-%COMP%]{font-size:1rem;font-weight:600;color:#0d3d2f;margin-bottom:12px;display:flex;align-items:center;gap:8px}.info-icon[_ngcontent-%COMP%]{font-size:1.2rem;color:#e76f51;cursor:pointer}.info-icon[_ngcontent-%COMP%]:hover{color:#d65d43}.inline-photo-section[_ngcontent-%COMP%]{display:flex;align-items:center;margin-left:16px;margin-top:12px;margin-bottom:8px}.toggle-item[_ngcontent-%COMP%]   .inline-photo-section[_ngcontent-%COMP%]{margin-top:0;margin-bottom:0}.inline-photo-section.centered[_ngcontent-%COMP%]{justify-content:center;margin-left:0}.photo-preview-only[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:12px;margin-top:8px;background:#f9f9f9;border-radius:8px;border-left:4px solid #52a676}.photo-preview-only[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:4px}.photo-preview-only[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #52a676;transition:transform .2s ease,box-shadow .2s ease;touch-action:manipulation;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}.photo-preview-only[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]:hover{transform:scale(1.05);box-shadow:0 4px 12px #2d865966}.photo-preview-only[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]:active{transform:scale(.98)}.photo-preview-only[_ngcontent-%COMP%]   .photo-wrapper[_ngcontent-%COMP%]   .click-hint[_ngcontent-%COMP%]{font-size:10px;color:#999;font-style:italic;text-align:center;white-space:nowrap}.coastal-button[_ngcontent-%COMP%]{--background: #4fb3bf;--background-hover: #3a9aa5;--background-activated: #3a9aa5;--color: white;--border-radius: 8px;font-weight:600;text-transform:none;letter-spacing:.3px;margin-left:20px;margin-right:5px}.coastal-button[_ngcontent-%COMP%]:hover{--background: #3a9aa5}.centered[_ngcontent-%COMP%]   .coastal-button[_ngcontent-%COMP%]{margin-left:0}.toggle-item[_ngcontent-%COMP%]{--padding-start: 0;--padding-end: 0;--inner-padding-end: 0;margin-bottom:0;display:flex;align-items:center;justify-content:space-between;gap:16px}.toggle-labels[_ngcontent-%COMP%]{display:flex;align-items:center;gap:0px;position:relative}.toggle-labels[_ngcontent-%COMP%]   .toggle-no[_ngcontent-%COMP%], .toggle-labels[_ngcontent-%COMP%]   .toggle-yes[_ngcontent-%COMP%]{font-size:.9rem;font-weight:600;min-width:35px;width:35px;text-align:center;flex-shrink:0}.toggle-labels[_ngcontent-%COMP%]   .toggle-no[_ngcontent-%COMP%]{color:#888;visibility:visible}.toggle-labels[_ngcontent-%COMP%]   .toggle-no[_ngcontent-%COMP%]:not(:last-child){margin-right:5px}.toggle-labels[_ngcontent-%COMP%]   .toggle-yes[_ngcontent-%COMP%]{color:#52a676;visibility:visible}.toggle-labels[_ngcontent-%COMP%]   .toggle-yes[_ngcontent-%COMP%]:not(:first-child){margin-left:5px}.toggle-labels[_ngcontent-%COMP%]   .toggle-no[hidden][_ngcontent-%COMP%], .toggle-labels[_ngcontent-%COMP%]   .toggle-yes[hidden][_ngcontent-%COMP%]{visibility:hidden;display:block!important}.coastal-toggle[_ngcontent-%COMP%]{--background: #ddd;--background-checked: #52a676;--handle-background: white;--handle-background-checked: white;--handle-width: 26px;--handle-height: 26px;--handle-spacing: 3px;width:52px;height:32px;min-width:52px;flex-shrink:0}.coastal-toggle[_ngcontent-%COMP%]::part(track){height:32px;width:52px;border-radius:16px}.coastal-toggle[_ngcontent-%COMP%]::part(handle){width:26px;height:26px}.form-buttons[_ngcontent-%COMP%]{padding:0 16px;margin-top:24px;margin-bottom:32px}.form-buttons[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{margin-bottom:12px}.form-buttons[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]:last-child{margin-bottom:0}.form-buttons[_ngcontent-%COMP%]   ion-button.save-draft-button[_ngcontent-%COMP%]{margin:10px 0 12px}.form-buttons[_ngcontent-%COMP%]   .save-draft-button[_ngcontent-%COMP%]{--border-radius: 8px;height:48px;font-size:1rem;font-weight:500;--background: rgba(107, 124, 122, .1);--border-color: #6b7c7a;--color: #6b7c7a;--background-hover: rgba(107, 124, 122, .2);--background-activated: rgba(107, 124, 122, .3)}.form-buttons[_ngcontent-%COMP%]   .submit-button[_ngcontent-%COMP%]{margin:0;--border-radius: 8px;height:48px;font-size:1.125rem;font-weight:600;--background: #e76f51;--background-hover: #d65d43;--background-activated: #d65d43}.form-buttons[_ngcontent-%COMP%]   .submit-button[_ngcontent-%COMP%]:disabled{opacity:.5}.form-buttons[_ngcontent-%COMP%]   .discard-button[_ngcontent-%COMP%]{--border-radius: 8px;height:48px;font-size:1rem;font-weight:500;--color: #e76f51;--border-color: #e76f51;--border-width: 2px;--background-hover: rgba(231, 111, 81, .1);--background-activated: rgba(231, 111, 81, .2);--ripple-color: rgba(231, 111, 81, .3)}.form-buttons[_ngcontent-%COMP%]   .delete-button[_ngcontent-%COMP%]{margin-top:20px;--background: #d32f2f;--background-hover: #b71c1c;--background-activated: #b71c1c;font-weight:600;height:48px;font-size:1rem}.submit-button[_ngcontent-%COMP%]{margin:24px 16px 32px;--border-radius: 8px;height:48px;font-size:1.125rem;font-weight:600;--background: #e76f51;--background-hover: #d65d43;--background-activated: #d65d43}.submit-button[_ngcontent-%COMP%]:disabled{opacity:.5}ion-error[_ngcontent-%COMP%]{color:#e76f51!important;font-size:.75rem!important;margin-top:4px;padding-left:16px}ion-item.item-disabled[_ngcontent-%COMP%], ion-item.item-interactive-disabled[_ngcontent-%COMP%]{opacity:1!important;--opacity: 1 !important}ion-item.item-disabled[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], ion-item.item-interactive-disabled[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{opacity:1!important;color:#000!important}  .item-disabled,   .item-interactive-disabled{opacity:1!important}  .item-disabled ion-label,   .item-disabled .label-text,   .item-disabled .native-input,   .item-disabled .select-text,   .item-disabled .select-icon,   .item-interactive-disabled ion-label,   .item-interactive-disabled .label-text,   .item-interactive-disabled .native-input,   .item-interactive-disabled .select-text,   .item-interactive-disabled .select-icon{opacity:1!important;color:#000!important}  ion-select.select-disabled{opacity:1!important}  ion-select.select-disabled .select-text,   ion-select.select-disabled .select-icon,   ion-select.select-disabled .select-placeholder{opacity:1!important;color:#000!important}  ion-toggle.toggle-disabled{opacity:1!important}  ion-checkbox.checkbox-disabled{opacity:1!important}  ion-input.input-disabled,   ion-textarea.textarea-disabled{opacity:1!important}  ion-input.input-disabled .native-input,   ion-input.input-disabled .native-textarea,   ion-textarea.textarea-disabled .native-input,   ion-textarea.textarea-disabled .native-textarea{opacity:1!important;color:#000!important;-webkit-text-fill-color:#000!important}  ion-content.view-mode ion-checkbox,   ion-content.view-mode ion-toggle{pointer-events:none!important;cursor:default!important}  ion-content.view-mode ion-item:has(ion-checkbox){pointer-events:none!important}ion-item[_ngcontent-%COMP%]:has(ion-checkbox[formControlName=requiresUrgentAction])   ion-checkbox[_ngcontent-%COMP%]{--checkbox-background-checked: #e76f51 !important;--border-color-checked: #e76f51 !important;--border-color: #e76f51 !important;--checkmark-color: white !important}@media (max-width: 768px){.photo-item[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start}.photo-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:200px}ion-card[_ngcontent-%COMP%]{margin:12px}}"]}))}return r(),p})(),pe=(()=>{var r;class p{constructor(t){this.modalController=t}dismiss(){this.modalController.dismiss()}static#e=r=()=>(this.\u0275fac=function(o){return new(o||p)(e.rXU(g.W3))},this.\u0275cmp=e.VBU({type:p,selectors:[["app-fullscreen-photo-modal-pollution"]],decls:10,vars:2,consts:[["slot","end"],[3,"click"],["name","close"],[1,"ion-padding"],[1,"photo-container"],["alt","Full screen photo",3,"src"]],template:function(o,n){1&o&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return n.dismiss()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"div",4),e.nrm(9,"img",5),e.k0s()()),2&o&&(e.R7$(3),e.SpI("",n.photoType," Photo"),e.R7$(6),e.Y8G("src",n.photoUrl,e.B4B))},dependencies:[g.bv,g.Jm,g.QW,g.W9,g.eU,g.iq,g.BC,g.ai,C.MD],styles:[".photo-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;height:100%}.photo-container[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{max-width:100%;max-height:100%;object-fit:contain}"]}))}return r(),p})();const ge=[{path:"",component:ue}];let me=(()=>{var r;class p{static#e=r=()=>(this.\u0275fac=function(o){return new(o||p)},this.\u0275mod=e.$C({type:p}),this.\u0275inj=d.G2t({imports:[I.iI.forChild(ge),I.iI]}))}return r(),p})(),he=(()=>{var r;class p{static#e=r=()=>(this.\u0275fac=function(o){return new(o||p)},this.\u0275mod=e.$C({type:p}),this.\u0275inj=d.G2t({imports:[C.MD,k.YN,k.X1,g.bv,me]}))}return r(),p})()},9187(Y,N,b){b.d(N,{C:()=>G});var C=b(467),k=b(2084),g=b(2615),I=b(5029),_=b(918),j=b(8863);let G=(()=>{var e;class d{constructor(a,m,c){this.supabase=a,this.sharedDataService=m,this.monitoringLog=c}deleteEntry(a){var m=this;return(0,C.A)(function*(){console.log("[EntryDeletionService] Starting deletion process for:",a);try{const c=yield m.fetchOriginalEntry(a.tableName,a.reportId);if(!c)throw new Error(`Entry not found in table ${a.tableName} with reportId ${a.reportId}`);console.log("[EntryDeletionService] Original entry fetched:",c);const u=yield m.backupToDeletedFiles(a,c);console.log("[EntryDeletionService] Backup completed:",u),yield m.recordDeletionMetadata(a,u,c),console.log("[EntryDeletionService] Deletion metadata recorded"),yield m.deleteImagesFromBucket(c,a.formType,a.reportId),console.log("[EntryDeletionService] Images deleted from bucket"),yield m.deleteJsonFromStorage(a.formType,a.reportId),console.log("[EntryDeletionService] JSON file deleted from storage"),yield m.deleteFromTable(a.tableName,a.reportId),console.log("[EntryDeletionService] Entry deleted from table"),yield m.deleteLocalFile(a.formType,a.reportId),console.log("[EntryDeletionService] Local file deleted");const P=m.getEntrySummary(c,a.formType);m.monitoringLog.recordFormDeleted(a.deletedBy,a.formType,a.reportId,P),console.log("[EntryDeletionService] \u2705 Deletion process completed successfully")}catch(c){throw console.error("[EntryDeletionService] \u274c Deletion process failed:",c),c}})()}getEntrySummary(a,m){const c=[];return a?.location&&c.push(a.location),a?.zone_number&&c.push(`Z${a.zone_number}`),a?.quad_number&&c.push(`Q${a.quad_number}`),a?.observation_date&&c.push(a.observation_date),c.join(", ")||m}fetchOriginalEntry(a,m){var c=this;return(0,C.A)(function*(){const{data:u,error:P}=yield c.supabase.getClient().from(a).select("*").eq("report_id",m).single();if(P)throw console.error("[EntryDeletionService] Error fetching original entry:",P),P;return u})()}backupToDeletedFiles(a,m){var c=this;return(0,C.A)(function*(){const u=`${a.formType}/${a.reportId}`,P=`${u}/${a.reportId}.json`,M=new Blob([JSON.stringify(m,null,2)],{type:"application/json"}),{error:w}=yield c.supabase.getClient().storage.from("deleted_files").upload(P,M);if(w)throw console.error("[EntryDeletionService] Error backing up JSON:",w),w;const E=[],W=c.getImageBucketName(a.formType),U=c.extractImagePathsFromEntry(m,a.formType,a.reportId);for(const $ of U)if($)try{const{data:A,error:B}=yield c.supabase.getClient().storage.from(W).download($);if(B){console.warn("[EntryDeletionService] Could not download image:",$,B);continue}const z=`${u}/${$.split("/").pop()}`,{error:V}=yield c.supabase.getClient().storage.from("deleted_files").upload(z,A);V?console.warn("[EntryDeletionService] Could not backup image:",z,V):E.push(z)}catch(A){console.warn("[EntryDeletionService] Error processing image:",A)}return{backupFolderPath:u,jsonBackupPath:P,imageBackupPaths:E}})()}recordDeletionMetadata(a,m,c){var u=this;return(0,C.A)(function*(){const P={original_entry:c,backup_paths:{json:m.jsonBackupPath,images:m.imageBackupPaths},deletion_timestamp:(0,k.E)()},{error:M}=yield u.supabase.getClient().from("deleted_metadata_files").insert({original_report_id:a.reportId,form_type:a.formType,deleted_by:a.deletedBy,deleted_by_email:a.deletedByEmail,original_submitted_by:a.originalSubmittedBy||c.submittedBy,original_submitted_at:a.originalSubmittedAt||c.createdAt,backup_folder_path:m.backupFolderPath,original_table_name:a.tableName,original_storage_path:u.getStoragePath(a.tableName,a.reportId),metadata:P});if(M)throw console.error("[EntryDeletionService] Error recording deletion metadata:",M),M})()}deleteImagesFromBucket(a,m,c){var u=this;return(0,C.A)(function*(){const P=u.getImageBucketName(m),M=u.extractImagePathsFromEntry(a,m,c);for(const w of M)if(w)try{const{error:E}=yield u.supabase.getClient().storage.from(P).remove([w]);E&&console.warn("[EntryDeletionService] Could not delete image:",w,E)}catch(E){console.warn("[EntryDeletionService] Error deleting image:",E)}})()}deleteJsonFromStorage(a,m){var c=this;return(0,C.A)(function*(){const u=c.getReportsBucketName(a),P=`${m}.json`,{error:M}=yield c.supabase.getClient().storage.from(u).remove([P]);M&&console.warn("[EntryDeletionService] Could not delete JSON from storage:",P,M)})()}deleteFromTable(a,m){var c=this;return(0,C.A)(function*(){const{error:u}=yield c.supabase.getClient().from(a).delete().eq("report_id",m);if(u)throw console.error("[EntryDeletionService] Error deleting from table:",u),u})()}deleteLocalFile(a,m){var c=this;return(0,C.A)(function*(){try{const u=c.getLocalFileName(a,m);yield c.sharedDataService.deleteJsonFile(u)}catch(u){console.warn("[EntryDeletionService] Could not delete local file:",u)}})()}getReportsBucketName(a){return a}getImageBucketName(a){return{"flora-fauna":"flora-fauna-images",biomass:"biomass-images",health:"health-images",outplanting:"outplanting-images",restoration:"restoration-images",cleanup:"cleanup-images",pollution:"pollution-images",disturbances:"disturbances-images"}[a]||`${a}-images`}extractImagePathsFromEntry(a,m,c){const u=[];if("health"===m)return u.push(`${c}/soil.jpg`),u.push(`${c}/predation.jpg`),u.push(`${c}/pollution.jpg`),u;if("pollution"===m){u.push(`${c}/greyWater.jpg`),u.push(`${c}/trash.jpg`),u.push(`${c}/sewage.jpg`);for(let P=1;P<=10;P++)u.push(`${c}/photo_${P}.jpg`);return u}if("disturbances"===m)return u.push(`${c}/harvest.jpg`),u.push(`${c}/clearing.jpg`),u.push(`${c}/construction.jpg`),u.push(`${c}/fallenTree.jpg`),u.push(`${c}/erosion.jpg`),u.push(`${c}/accretion.jpg`),u.push(`${c}/diseases.jpg`),u;for(let P=1;P<=20;P++)u.push(`${c}/photo_${P}.jpg`);return u}getStoragePath(a,m){return`${a}/${m}.json`}getLocalFileName(a,m){return`${m}.json`}static#e=e=()=>(this.\u0275fac=function(m){return new(m||d)(g.KVO(I.L),g.KVO(_.H),g.KVO(j.u))},this.\u0275prov=g.jDH({token:d,factory:d.\u0275fac,providedIn:"root"}))}return e(),d})()}}]);