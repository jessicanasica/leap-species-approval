"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6059],{152(v,f,c){c.d(f,{B:()=>m});var h=c(8839),_=c(9974),d=c(4360);function m(E,i=h.E){return(0,_.N)((l,s)=>{let r=null,u=null,e=null;const o=()=>{if(r){r.unsubscribe(),r=null;const n=u;u=null,s.next(n)}};function t(){const n=e+E,a=i.now();if(a<n)return r=this.schedule(void 0,n-a),void s.add(r);o()}l.subscribe((0,d._)(s,n=>{u=n,e=i.now(),r||(r=i.schedule(t,E),s.add(r))},()=>{o(),s.complete()},void 0,()=>{u=r=null}))})}},4718(v,f,c){c.d(f,{h:()=>_});var h=c(3664);let _=(()=>{var d;class m{constructor(i,l){this.el=i,this.renderer=l,this.scale=1,this.lastScale=1,this.translateX=0,this.translateY=0,this.lastTranslateX=0,this.lastTranslateY=0,this.initialDistance=0,this.lastTouchX=0,this.lastTouchY=0,this.isPinching=!1,this.isPanning=!1,this.isMouseDragging=!1,this.lastMouseX=0,this.lastMouseY=0,this.renderer.setStyle(this.el.nativeElement,"transition","transform 0.1s ease-out"),this.renderer.setStyle(this.el.nativeElement,"transform-origin","center center"),this.renderer.setStyle(this.el.nativeElement,"cursor","grab")}onTouchStart(i){2===i.touches.length?(this.isPinching=!0,this.isPanning=!1,this.initialDistance=this.getDistance(i.touches[0],i.touches[1]),this.lastScale=this.scale,i.preventDefault()):1===i.touches.length&&this.scale>1&&(this.isPanning=!0,this.isPinching=!1,this.lastTouchX=i.touches[0].clientX,this.lastTouchY=i.touches[0].clientY,this.lastTranslateX=this.translateX,this.lastTranslateY=this.translateY,this.renderer.setStyle(this.el.nativeElement,"cursor","grabbing"),i.preventDefault())}onTouchMove(i){if(this.isPinching&&2===i.touches.length){const r=this.getDistance(i.touches[0],i.touches[1]);this.initialDistance>0&&(this.scale=Math.max(1,Math.min(5,this.lastScale*(r/this.initialDistance))),this.updateTransform()),i.preventDefault()}else if(this.isPanning&&1===i.touches.length&&this.scale>1){const s=i.touches[0].clientY-this.lastTouchY;this.translateX=this.lastTranslateX+(i.touches[0].clientX-this.lastTouchX),this.translateY=this.lastTranslateY+s,this.updateTransform(),i.preventDefault()}}onTouchEnd(i){i.touches.length<2&&(this.isPinching=!1,this.initialDistance=0),0===i.touches.length&&(this.isPanning=!1,this.renderer.setStyle(this.el.nativeElement,"cursor","grab"),1===this.scale&&(this.translateX=0,this.translateY=0,this.updateTransform()))}onDoubleClick(i){1===this.scale?this.scale=2.5:(this.scale=1,this.translateX=0,this.translateY=0),this.updateTransform(),i.preventDefault()}onWheel(i){i.preventDefault(),this.scale=Math.max(1,Math.min(5,this.scale*(i.deltaY<0?1.15:.87))),1===this.scale&&(this.translateX=0,this.translateY=0),this.updateTransform()}onMouseDown(i){this.scale>1&&(this.isMouseDragging=!0,this.lastMouseX=i.clientX,this.lastMouseY=i.clientY,this.lastTranslateX=this.translateX,this.lastTranslateY=this.translateY,this.renderer.setStyle(this.el.nativeElement,"cursor","grabbing"),i.preventDefault())}onMouseMove(i){if(this.isMouseDragging&&this.scale>1){const s=i.clientY-this.lastMouseY;this.translateX=this.lastTranslateX+(i.clientX-this.lastMouseX),this.translateY=this.lastTranslateY+s,this.updateTransform(),i.preventDefault()}}onMouseUp(){this.isMouseDragging&&(this.isMouseDragging=!1,this.renderer.setStyle(this.el.nativeElement,"cursor","grab"))}getDistance(i,l){const s=i.clientX-l.clientX,r=i.clientY-l.clientY;return Math.sqrt(s*s+r*r)}updateTransform(){this.renderer.setStyle(this.el.nativeElement,"transform",`scale(${this.scale}) translate(${this.translateX/this.scale}px, ${this.translateY/this.scale}px)`)}static#e=d=()=>(this.\u0275fac=function(l){return new(l||m)(h.rXU(h.aKT),h.rXU(h.sFG))},this.\u0275dir=h.FsC({type:m,selectors:[["","appPinchZoom",""]],hostBindings:function(l,s){1&l&&h.bIt("touchstart",function(u){return s.onTouchStart(u)})("touchmove",function(u){return s.onTouchMove(u)})("touchend",function(u){return s.onTouchEnd(u)})("dblclick",function(u){return s.onDoubleClick(u)})("wheel",function(u){return s.onWheel(u)})("mousedown",function(u){return s.onMouseDown(u)})("mousemove",function(u){return s.onMouseMove(u)},h.EBC)("mouseup",function(){return s.onMouseUp()},h.EBC)}}))}return d(),m})()},5415(v,f,c){c.d(f,{Z:()=>_});const _=(0,c(5083).F3)("ScreenOrientation",{web:()=>c.e(9061).then(c.bind(c,9061)).then(d=>new d.ScreenOrientationWeb)})},9187(v,f,c){c.d(f,{C:()=>l});var h=c(467),_=c(2084),d=c(2615),m=c(5029),E=c(918),i=c(8863);let l=(()=>{var s;class r{constructor(e,o,t){this.supabase=e,this.sharedDataService=o,this.monitoringLog=t}deleteEntry(e){var o=this;return(0,h.A)(function*(){console.log("[EntryDeletionService] Starting deletion process for:",e);try{const t=yield o.fetchOriginalEntry(e.tableName,e.reportId);if(!t)throw new Error(`Entry not found in table ${e.tableName} with reportId ${e.reportId}`);console.log("[EntryDeletionService] Original entry fetched:",t);const n=yield o.backupToDeletedFiles(e,t);console.log("[EntryDeletionService] Backup completed:",n),yield o.recordDeletionMetadata(e,n,t),console.log("[EntryDeletionService] Deletion metadata recorded"),yield o.deleteImagesFromBucket(t,e.formType,e.reportId),console.log("[EntryDeletionService] Images deleted from bucket"),yield o.deleteJsonFromStorage(e.formType,e.reportId),console.log("[EntryDeletionService] JSON file deleted from storage"),yield o.deleteFromTable(e.tableName,e.reportId),console.log("[EntryDeletionService] Entry deleted from table"),yield o.deleteLocalFile(e.formType,e.reportId),console.log("[EntryDeletionService] Local file deleted");const a=o.getEntrySummary(t,e.formType);o.monitoringLog.recordFormDeleted(e.deletedBy,e.formType,e.reportId,a),console.log("[EntryDeletionService] \u2705 Deletion process completed successfully")}catch(t){throw console.error("[EntryDeletionService] \u274c Deletion process failed:",t),t}})()}getEntrySummary(e,o){const t=[];return e?.location&&t.push(e.location),e?.zone_number&&t.push(`Z${e.zone_number}`),e?.quad_number&&t.push(`Q${e.quad_number}`),e?.observation_date&&t.push(e.observation_date),t.join(", ")||o}fetchOriginalEntry(e,o){var t=this;return(0,h.A)(function*(){const{data:n,error:a}=yield t.supabase.getClient().from(e).select("*").eq("report_id",o).single();if(a)throw console.error("[EntryDeletionService] Error fetching original entry:",a),a;return n})()}backupToDeletedFiles(e,o){var t=this;return(0,h.A)(function*(){const n=`${e.formType}/${e.reportId}`,a=`${n}/${e.reportId}.json`,g=new Blob([JSON.stringify(o,null,2)],{type:"application/json"}),{error:p}=yield t.supabase.getClient().storage.from("deleted_files").upload(a,g);if(p)throw console.error("[EntryDeletionService] Error backing up JSON:",p),p;const D=[],M=t.getImageBucketName(e.formType),B=t.extractImagePathsFromEntry(o,e.formType,e.reportId);for(const y of B)if(y)try{const{data:b,error:T}=yield t.supabase.getClient().storage.from(M).download(y);if(T){console.warn("[EntryDeletionService] Could not download image:",y,T);continue}const P=`${n}/${y.split("/").pop()}`,{error:S}=yield t.supabase.getClient().storage.from("deleted_files").upload(P,b);S?console.warn("[EntryDeletionService] Could not backup image:",P,S):D.push(P)}catch(b){console.warn("[EntryDeletionService] Error processing image:",b)}return{backupFolderPath:n,jsonBackupPath:a,imageBackupPaths:D}})()}recordDeletionMetadata(e,o,t){var n=this;return(0,h.A)(function*(){const a={original_entry:t,backup_paths:{json:o.jsonBackupPath,images:o.imageBackupPaths},deletion_timestamp:(0,_.E)()},{error:g}=yield n.supabase.getClient().from("deleted_metadata_files").insert({original_report_id:e.reportId,form_type:e.formType,deleted_by:e.deletedBy,deleted_by_email:e.deletedByEmail,original_submitted_by:e.originalSubmittedBy||t.submittedBy,original_submitted_at:e.originalSubmittedAt||t.createdAt,backup_folder_path:o.backupFolderPath,original_table_name:e.tableName,original_storage_path:n.getStoragePath(e.tableName,e.reportId),metadata:a});if(g)throw console.error("[EntryDeletionService] Error recording deletion metadata:",g),g})()}deleteImagesFromBucket(e,o,t){var n=this;return(0,h.A)(function*(){const a=n.getImageBucketName(o),g=n.extractImagePathsFromEntry(e,o,t);for(const p of g)if(p)try{const{error:D}=yield n.supabase.getClient().storage.from(a).remove([p]);D&&console.warn("[EntryDeletionService] Could not delete image:",p,D)}catch(D){console.warn("[EntryDeletionService] Error deleting image:",D)}})()}deleteJsonFromStorage(e,o){var t=this;return(0,h.A)(function*(){const n=t.getReportsBucketName(e),a=`${o}.json`,{error:g}=yield t.supabase.getClient().storage.from(n).remove([a]);g&&console.warn("[EntryDeletionService] Could not delete JSON from storage:",a,g)})()}deleteFromTable(e,o){var t=this;return(0,h.A)(function*(){const{error:n}=yield t.supabase.getClient().from(e).delete().eq("report_id",o);if(n)throw console.error("[EntryDeletionService] Error deleting from table:",n),n})()}deleteLocalFile(e,o){var t=this;return(0,h.A)(function*(){try{const n=t.getLocalFileName(e,o);yield t.sharedDataService.deleteJsonFile(n)}catch(n){console.warn("[EntryDeletionService] Could not delete local file:",n)}})()}getReportsBucketName(e){return e}getImageBucketName(e){return{"flora-fauna":"flora-fauna-images",biomass:"biomass-images",health:"health-images",outplanting:"outplanting-images",restoration:"restoration-images",cleanup:"cleanup-images",pollution:"pollution-images",disturbances:"disturbances-images"}[e]||`${e}-images`}extractImagePathsFromEntry(e,o,t){const n=[];if("health"===o)return n.push(`${t}/soil.jpg`),n.push(`${t}/predation.jpg`),n.push(`${t}/pollution.jpg`),n;if("pollution"===o){n.push(`${t}/greyWater.jpg`),n.push(`${t}/trash.jpg`),n.push(`${t}/sewage.jpg`);for(let a=1;a<=10;a++)n.push(`${t}/photo_${a}.jpg`);return n}if("disturbances"===o)return n.push(`${t}/harvest.jpg`),n.push(`${t}/clearing.jpg`),n.push(`${t}/construction.jpg`),n.push(`${t}/fallenTree.jpg`),n.push(`${t}/erosion.jpg`),n.push(`${t}/accretion.jpg`),n.push(`${t}/diseases.jpg`),n;for(let a=1;a<=20;a++)n.push(`${t}/photo_${a}.jpg`);return n}getStoragePath(e,o){return`${e}/${o}.json`}getLocalFileName(e,o){return`${o}.json`}static#e=s=()=>(this.\u0275fac=function(o){return new(o||r)(d.KVO(m.L),d.KVO(E.H),d.KVO(i.u))},this.\u0275prov=d.jDH({token:r,factory:r.\u0275fac,providedIn:"root"}))}return s(),r})()}}]);